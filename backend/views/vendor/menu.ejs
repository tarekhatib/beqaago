<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vendor Menu | BeqaaGo</title>
  <link rel="stylesheet" href="/styles/vendor.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    /* INPUTS */
    input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 8px;
      font-size: 14px;
    }

    /* BUTTONS */
    button {
      background: #00b050;
      color: white;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    button:hover { opacity: 0.9; }

    .btn-edit-item { background: #2980b9; }
    .btn-delete-item { background: #c0392b; }
    .btn-cancel-edit { background: #555; }

    /* ITEM CARD */
    .menu-item {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .menu-view {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .menu-left { display: flex; flex-direction: column; gap: 4px; }
    .menu-actions button { margin-left: 8px; }

    /* EDIT MODE */
    .menu-edit input { margin-bottom: 10px; }
    .menu-edit button { margin-right: 10px; }

    /* DELETE MODAL */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.45);
      display: none; /* hidden by default */
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .modal-box {
      background: white;
      padding: 25px;
      width: 270px;
      border-radius: 12px;
      text-align: center;
      animation: pop 0.2s ease;
    }
    @keyframes pop {
      from { transform: scale(0.8); opacity: 0; }
      to   { transform: scale(1); opacity: 1; }
    }
    .modal-actions { margin-top: 15px; display: flex; gap: 10px; justify-content: center; }
    .btn-danger { background: #e74c3c; }
    .btn-secondary { background: #ccc; color: #333; }
  </style>
</head>

<body>
<div class="vendor-container">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h2 class="brand">BeqaaGo Vendor</h2>
    <nav>
      <a href="/vendor/dashboard"><i class="fa-solid fa-chart-line"></i> Dashboard</a>
      <a href="/vendor/menu" class="active"><i class="fa-solid fa-utensils"></i> Menu Items</a>
      <a href="/vendor/orders"><i class="fa-solid fa-clipboard-list"></i> Orders</a>
      <a href="/vendor/settings"><i class="fa-solid fa-gear"></i> Settings</a>
      <a href="#" onclick="vendorLogout()" class="logout">
        <i class="fa-solid fa-right-from-bracket"></i> Logout
      </a>
    </nav>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <h1>Your Menu / Items</h1>

    <!-- ADD ITEM -->
    <section>
      <h2>Add New Item</h2>

      <form id="menu-form">
        <input type="text" id="item-name" placeholder="Item name" required />
        <input type="text" id="item-desc" placeholder="Description (optional)" />
        <input type="number" id="item-price" placeholder="Price" step="0.01" required />

        <button type="submit">Add Item</button>
        <p id="menu-msg" style="margin-top:8px;font-size:0.9rem;"></p>
      </form>
    </section>

    <!-- ITEMS LIST -->
    <section style="margin-top:30px;">
      <h2>Existing Items</h2>
      <div id="menu-list">Loading...</div>
    </section>
  </main>
</div>

<!-- DELETE CONFIRM MODAL -->
<div id="delete-modal" class="modal-overlay">
  <div class="modal-box">
    <h3>Delete Item?</h3>
    <p>This action cannot be undone.</p>
    <div class="modal-actions">
      <button id="confirm-delete" class="btn-danger">Delete</button>
      <button id="cancel-delete" class="btn-secondary">Cancel</button>
    </div>
  </div>
</div>
<!-- INFO POPUP (for delete errors) -->
<div id="info-modal" class="modal-overlay">
  <div class="modal-box">
    <h3>Cannot Delete Item</h3>
    <p id="info-message"></p>

    <div class="modal-actions">
      <button id="close-info" class="btn-secondary">OK</button>
    </div>
  </div>
</div>


<script>
  function vendorLogout() {
    localStorage.removeItem("user");
    localStorage.removeItem("token");
    window.location.href = "/login";
  }

  let shopId = null;
  let deleteTargetId = null; // used for modal delete

  document.addEventListener("DOMContentLoaded", initVendorMenu);

  async function initVendorMenu() {
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    if (!user.id || user.role !== "vendor") {
      window.location.href = "/login";
      return;
    }

    const r = await fetch(`/api/shops/owner/${user.id}`);
    const shop = await r.json();

    if (!shop.id) return window.location.href = "/vendor/create-shop";

    shopId = shop.id;

    await loadMenu();
    document.getElementById("menu-form").addEventListener("submit", submitMenuForm);
  }

  async function loadMenu() {
    const list = document.getElementById("menu-list");

    try {
      const res = await fetch(`/api/shops/${shopId}/items`);
      const items = await res.json();

      if (!items.length) {
        list.innerHTML = "<p>No items yet.</p>";
        return;
      }

      list.innerHTML = items
        .map(i => `
          <div class="menu-item" data-id="${i.id}">
            <div class="menu-view">
              <div class="menu-left">
                <strong>${i.name}</strong>
                <small>${i.description || ""}</small>
                <strong style="color:#00b050;">$${Number(i.price).toFixed(2)}</strong>
              </div>

              <div class="menu-actions">
                <button type="button" class="btn-edit-item">Edit</button>
                <button type="button" class="btn-delete-item">Delete</button>
              </div>
            </div>

            <div class="menu-edit" style="display:none;">
              <input type="text" class="edit-name" value="${i.name}" />
              <input type="text" class="edit-desc" value="${i.description || ""}" />
              <input type="number" class="edit-price" step="0.01" value="${Number(i.price).toFixed(2)}" />

              <button type="button" class="btn-save-item">Save</button>
              <button type="button" class="btn-cancel-edit">Cancel</button>
            </div>
          </div>
        `)
        .join("");

      attachItemListeners();
    } catch {
      list.innerHTML = "<p>Failed to load menu.</p>";
    }
  }

  function attachItemListeners() {
    document.querySelectorAll(".btn-edit-item").forEach(btn => {
      btn.addEventListener("click", () => {
        const item = btn.closest(".menu-item");
        item.querySelector(".menu-view").style.display = "none";
        item.querySelector(".menu-edit").style.display = "block";
      });
    });

    document.querySelectorAll(".btn-cancel-edit").forEach(btn => {
      btn.addEventListener("click", () => {
        const item = btn.closest(".menu-item");
        item.querySelector(".menu-edit").style.display = "none";
        item.querySelector(".menu-view").style.display = "flex";
      });
    });

    document.querySelectorAll(".btn-save-item").forEach(btn => {
      btn.addEventListener("click", () => saveItemEdit(btn.closest(".menu-item")));
    });

    document.querySelectorAll(".btn-delete-item").forEach(btn => {
      btn.addEventListener("click", () => openDeleteModal(btn.closest(".menu-item")));
    });
  }

  async function submitMenuForm(e) {
    e.preventDefault();

   const name = document.getElementById("item-name").value.trim();
const description = document.getElementById("item-desc").value.trim();
const price = document.getElementById("item-price").value;


    const msg = document.getElementById("menu-msg");

    if (!name || !price) {
      msg.style.color = "red";
      msg.textContent = "Name & Price required.";
      return;
    }

    try {
      const res = await fetch(`/api/shops/${shopId}/items`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, description, price })
      });

      const data = await res.json();

      if (res.ok) {
        msg.style.color = "#00b050";
        msg.textContent = "Item added!";
        e.target.reset();
        loadMenu();
      } else {
        msg.style.color = "red";
        msg.textContent = data.message;
      }
    } catch {
      msg.style.color = "red";
      msg.textContent = "Server error";
    }
  }

  async function saveItemEdit(itemDiv) {
    const id = itemDiv.dataset.id;

    const name = itemDiv.querySelector(".edit-name").value.trim();
    const description = itemDiv.querySelector(".edit-desc").value.trim();
    const price = itemDiv.querySelector(".edit-price").value.trim();

    if (!name || !price) return alert("Name & price required");

    try {
      const res = await fetch(`/api/items/edit/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, description, price })
      });

      if (res.ok) loadMenu();
      else alert("Failed to update");
    } catch {
      alert("Error updating item");
    }
  }

  /* ------------------- DELETE MODAL ------------------- */

  function openDeleteModal(itemDiv) {
    deleteTargetId = itemDiv.dataset.id;
    document.getElementById("delete-modal").style.display = "flex";
  }

  document.getElementById("cancel-delete").onclick = () => {
    document.getElementById("delete-modal").style.display = "none";
    deleteTargetId = null;
  };

  document.getElementById("confirm-delete").onclick = async () => {
    if (!deleteTargetId) return;

    try {
      const res = await fetch(`/api/items/${deleteTargetId}`, { method: "DELETE" });

     const data = await res.json();

if (!res.ok) {
  showInfoModal(
    data.message ||
    "This item cannot be deleted because it is used in previous orders."
  );
  return;
}

loadMenu();

    } catch {
      alert("Error deleting item");
    }

    document.getElementById("delete-modal").style.display = "none";
  };
  function showInfoModal(message) {
  document.getElementById("info-message").innerText = message;
  document.getElementById("info-modal").style.display = "flex";
}

document.getElementById("close-info").onclick = () => {
  document.getElementById("info-modal").style.display = "none";
};

</script>

</body>
</html>
