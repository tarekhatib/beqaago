<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vendor Dashboard | BeqaaGo</title>
  <link rel="stylesheet" href="/styles/vendor.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>

<body>

<div class="vendor-container">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h2 class="brand">BeqaaGo Vendor</h2>

    <nav>
      <a href="/vendor/dashboard" class="active">
        <i class="fa-solid fa-chart-line"></i> Dashboard
      </a>

      <a href="/vendor/menu">
        <i class="fa-solid fa-utensils"></i> Menu Items
      </a>

      <a href="/vendor/orders">
        <i class="fa-solid fa-clipboard-list"></i> Orders
      </a>

      <a href="/vendor/settings">
        <i class="fa-solid fa-gear"></i> Settings
      </a>

      <a href="#" onclick="vendorLogout()" class="logout">
        <i class="fa-solid fa-right-from-bracket"></i> Logout
      </a>
    </nav>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main">
    <h1>Welcome, <span id="vendor-name"></span> ðŸ‘‹</h1>

    <section class="restaurant-info">
      <h2>Your Shop</h2>
      <div id="shop-box">Loading...</div>
    </section>

    <div class="stats">
      <div class="stat-box">
        <h3>Today's Orders</h3>
        <p id="today-orders">0</p>
      </div>

      <div class="stat-box">
        <h3>Total Orders</h3>
        <p id="total-orders">0</p>
      </div>

      <div class="stat-box">
        <h3>Status</h3>
        <label class="switch">
          <input type="checkbox" id="availability">
          <span class="slider"></span>
        </label>
        <p class="status-text" id="status-label">Offline</p>
      </div>
    </div>

    <section class="latest-orders">
      <h2>Recent Orders</h2>
      <div id="recent-box">Loading...</div>

      <a class="view-all-btn" href="/vendor/orders">
        View all orders â†’
      </a>
    </section>

  </main>
</div>

<script>
  function vendorLogout() {
    localStorage.removeItem("user");
    localStorage.removeItem("token");
    window.location.href = "/login";
  }

  document.addEventListener("DOMContentLoaded", initVendorDashboard);

  async function initVendorDashboard() {
    const vendor = JSON.parse(localStorage.getItem("user") || "{}");

    if (!vendor.id || vendor.role !== "vendor") {
      return window.location.href = "/login";
    }

    document.getElementById("vendor-name").innerText = vendor.name;

    // Get shop
    const res = await fetch(`/api/shops/owner/${vendor.id}`);
    const shop = await res.json();

    if (!shop.id) {
      return window.location.href = "/vendor/create-shop";
    }

    renderShopBox(shop);

    // Availability switch
    const availInput = document.getElementById("availability");
    const statusLabel = document.getElementById("status-label");

    availInput.checked = shop.is_open === 1;
    statusLabel.innerText = shop.is_open ? "Online" : "Offline";

    availInput.addEventListener("change", async () => {
      const isOpen = availInput.checked ? 1 : 0;
      statusLabel.innerText = isOpen ? "Online" : "Offline";

      // Update by shop id (for dashboard)
      await fetch(`/api/shops/status/${shop.id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ is_open: isOpen })
      });
    });

    // Stats + recent orders
    loadStats(shop.id);
    loadRecentOrders(shop.id);
  }

  function renderShopBox(shop) {
    document.getElementById("shop-box").innerHTML = `
      <div class="restaurant-card">
        <img src="${shop.image}" alt="${shop.name}" class="restaurant-img">
        <div>
          <h3>${shop.name}</h3>
          <p>${shop.location || ""}</p>
          <p>${shop.phone || ""}</p>
        </div>
      </div>
    `;
  }

  async function loadStats(shopId) {
    try {
      const res = await fetch(`/api/orders/stats/${shopId}`);
      const stats = await res.json();

      document.getElementById("today-orders").innerText = stats.today || 0;
      document.getElementById("total-orders").innerText = stats.total || 0;
    } catch (err) {
      console.error("Stats error:", err);
    }
  }

  async function loadRecentOrders(shopId) {
    try {
      const res = await fetch(`/api/orders/recent/${shopId}`);
      const orders = await res.json();
      const box = document.getElementById("recent-box");

      if (!orders.length) {
        box.innerHTML = "<p>No recent orders.</p>";
        return;
      }

      const latest = orders.slice(0, 3);

      box.innerHTML = latest
        .map(o => `
          <div class="order-preview">
            <strong>#${o.id}</strong>
            <p>${o.status} â€¢ $${o.total}</p>
            <p class="time">${new Date(o.created_at).toLocaleTimeString()}</p>
          </div>
        `)
        .join("");
    } catch (err) {
      console.error(err);
      document.getElementById("recent-box").innerText = "Failed to load orders.";
    }
  }
</script>

</body>
</html>
