<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>BeqaaGo | Dashboard</title>
  <link rel="stylesheet" href="/styles/dashboard.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>

<body>
  <%- include("partials/header") %>
  
  <!-- Update cart icon count -->
 <script>
  function updateHeaderCartCount() {
    const cart = JSON.parse(localStorage.getItem("cart") || "[]");
    const badge = document.getElementById("cart-count");

    if (!badge) return;

    const qty = cart.reduce((sum, item) => sum + (item.qty || 1), 0);
    badge.textContent = qty;
  }

  // Auto-run immediately when header loads
  document.addEventListener("DOMContentLoaded", updateHeaderCartCount);
</script>


  <!-- SEARCH -->
  <div class="search-bar">
    <i class="fa-solid fa-magnifying-glass"></i>
    <input type="text" id="search" placeholder="Search 'Fast Food'">
    <i class="fa-solid fa-sliders"></i>
  </div>

  <!-- PROMO -->
  <div class="promo-card">
    <div class="promo-text">
      <h3>üéâ Free Delivery</h3>
      <p>On your first 3 orders</p>
    </div>
    <img src="/images/icons/freedelivery.png" alt="Promo">
  </div>

  <!-- CATEGORIES -->
  <section class="categories">
    <div class="cat active"><img src="/images/icons/all.png"><p>All</p></div>
<div class="cat"><img src="/images/icons/food.jpg"><p>Food</p></div>
<div class="cat"><img src="/images/icons/fresh.webp"><p>Fresh</p></div>
<div class="cat"><img src="/images/icons/skincare.avif"><p>Beauty</p></div>
<div class="cat"><img src="/images/icons/pharmacy.png"><p>Pharmacy</p></div>
<div class="cat"><img src="/images/icons/shop.jpg"><p>Supermarket</p></div>

  </section>

  <!-- SHOPS -->
  <section class="vendors">
    <h2>Nearby Shops üõçÔ∏è</h2>
    <div id="shop-grid" class="vendor-grid">Loading shops...</div>
  </section>

  <%- include("partials/footer") %>

  <script>
  let allShops = [];

  document.addEventListener("DOMContentLoaded", () => {
    loadShops();
    setupCategoryFilters();
  });

  async function loadShops() {
    const grid = document.getElementById("shop-grid");

    try {
      const res = await fetch("/api/shops");
      allShops = await res.json();

      renderShops(allShops);
    } catch (err) {
      console.error(err);
      grid.innerHTML = "<p>‚ö†Ô∏è Failed to load shops.</p>";
    }
  }
document.getElementById("search").addEventListener("input", async (e) => {
  const q = e.target.value.trim();

  // If empty ‚Üí show all shops
  if (q === "") {
    renderShops(allShops);
    return;
  }

  try {
    const res = await fetch(`/api/shops/search?q=${encodeURIComponent(q)}`);
    const results = await res.json();

    renderShops(results);
  } catch (err) {
    console.error("Search error:", err);
  }
});

  function renderShops(list) {
    const grid = document.getElementById("shop-grid");

    if (!list.length) {
      grid.innerHTML = "<p>No shops available.</p>";
      return;
    }

    grid.innerHTML = list.map(s => `
      <div class="vendor-card" onclick="openStore(${s.id})">

        <img src="${s.image}" alt="${s.name}">

        <div class="info">
          <h3>${s.name}</h3>
          <p>${s.location || "Beqaa"}</p>

          ${s.is_open
            ? `<span class="open-badge">Open</span>`
            : `<span class="closed-badge">Not Available Right Now</span>`}
        </div>

      </div>
    `).join("");
  }

  function setupCategoryFilters() {
    const cats = document.querySelectorAll(".cat");
    cats.forEach(cat => {
      cat.addEventListener("click", () => {
        document.querySelector(".cat.active")?.classList.remove("active");
        cat.classList.add("active");

        const label = cat.querySelector("p").innerText;

        filterShops(label);
      });
    });
  }

 function filterShops(category) {

  if (category === "All") {
    return renderShops(allShops);
  }

  const map = {
    "Food": 2,
    "Fresh": 3,
    "Beauty": 4,
    "Pharmacy": 5,
    "Supermarket": 6
  };

  const categoryId = map[category];

  if (!categoryId) {
    // fallback (should never happen)
    return renderShops(allShops);
  }

  const filtered = allShops.filter(s => s.category_id === categoryId);
  return renderShops(filtered);
}


  function openStore(id) {
    window.location.href = `/store/${id}`;
  }

  function openLocation() {
    if (!navigator.geolocation) return;

    navigator.geolocation.getCurrentPosition(async (pos) => {
      const { latitude, longitude } = pos.coords;
      try {
        const res = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`
        );
        const data = await res.json();
        document.getElementById("user-address").innerText =
          data.address.city || data.address.town || "Beqaa";
      } catch {
        document.getElementById("user-address").innerText = "Location found";
      }
    },
      () => { document.getElementById("user-address").innerText = "Location Off"; }
    );
  }

  openLocation();
</script>


</body>
</html>
